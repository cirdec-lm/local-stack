events {

}

http {
  # Get the target service from the subfolder of the uri
  map $request_uri $service {
     ~^/(?<subfolder>[a-zA-Z0-9-_]+)/?(.*)$ $subfolder;
  }

	server {
    listen 80;

    location /nats-ui {
      # Docker resolver
      resolver 127.0.0.11 ipv6=off valid=10s;
      resolver_timeout 10s;
      set $backend "http://nats-ui:80";

      proxy_pass $backend;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_redirect $backend http://veille.bzh/nats-ui;
      proxy_redirect / /veille.bzh/nats-ui;
    }

    location / {
      # Docker resolver
      resolver 127.0.0.11 ipv6=off valid=10s;
      resolver_timeout 10s;
      set $backend "http://$service:8080";

      rewrite /[a-zA-Z0-9-_]+/?(.*) /$1  break;
      # fix missing trailing slash (ex: /admin => /admin/)
      if ($uri = "/$service") { return 302 $uri/; }

      proxy_pass $backend;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_redirect $backend http://veille.bzh/$service;
      proxy_redirect / /veille.bzh/$service;
    }
	}
}
